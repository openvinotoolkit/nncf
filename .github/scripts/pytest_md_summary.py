# Copyright (c) 2026 Intel Corporation
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#      http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import sys
from dataclasses import dataclass
from pathlib import Path

from defusedxml import ElementTree as ET


@dataclass
class TestInfo:
    name: str
    status: str
    time: float
    message: str

    def to_markdown_row(self) -> str:
        message = self.message.splitlines()[0][:60] if self.message else ""
        return f"| {self.name} | {self.status} | {self.time:.0f} | {message} |"

    def __lt__(self, other: object) -> bool:
        """Enable sorting by name."""
        if not isinstance(other, TestInfo):
            return NotImplemented
        return self.name < other.name


def parse_xml_report(xml_file: Path) -> list[TestInfo]:
    """
    Parse the XML report generated by pytest.

    :param xml_file: Path to the XML report file
    :return: List of test info
    """
    try:
        tree = ET.parse(xml_file)
    except FileNotFoundError:
        return []

    root = tree.getroot()

    test_info = []

    # Iterate over test cases
    for testcase in root.findall(".//testcase"):
        test_name = testcase.get("name")
        time_duration = float(testcase.get("time", "0"))
        message = ""
        if testcase.find("failure") is not None:
            status = "Failed"
            message = testcase.find("failure").get("message", "")
        elif testcase.find("error") is not None:
            status = "Error"
        elif testcase.find("skipped") is not None:
            if "xfail" in testcase.find("skipped").get("type", ""):
                status = "Xfail"
                message = testcase.find("skipped").get("message", "")
            else:
                status = "Skipped"
                message = testcase.find("skipped").get("message", "")
        else:
            status = "Ok"

        test_info.append(
            TestInfo(
                name=test_name,
                status=status,
                time=time_duration,
                message=message,
            )
        )

    return test_info


if __name__ == "__main__":
    """
    This script generates a summary table in Markdown format from XML reports generated by pytest.
    Finds all XML files recursively in the specified directory.

    Usage in GitHub workflow:
        - name: Test Summary
        if: ${{ !cancelled() }}
        run: |
            python .github/scripts/pytest_md_summary.py test-results >> $GITHUB_STEP_SUMMARY
    """
    try:
        xml_files = []
        for root in sys.argv[1:]:
            xml_files.extend(Path(root).rglob("*.xml"))

        if not xml_files:
            sys.exit(1)

        all_tests: list[TestInfo] = []
        for xml_file in sorted(xml_files):
            all_tests.extend(parse_xml_report(xml_file))

        if all_tests:
            print("| Test Name | Status | Time | Message |")
            print("|:----------|:------:|-----:|:--------|")
            for t in sorted(all_tests):
                print(t.to_markdown_row())
    except Exception as e:
        print(f"Error: {e}")
